# Pharmacy Management System - Core Modules Implementation Plan

## Executive Summary

This document outlines the phased implementation plan for building core modules of the Pharmacy Management System based on the existing `schema.prisma`. The schema remains unchanged, and this plan focuses on implementing the business logic, APIs, and services layer.

---

## Schema Overview

The system is built on a **multi-tenant architecture** supporting pharmacy operations including:
- Multi-tenant data isolation via `Tenant` model
- User management with role-based access (ADMIN, PHARMACIST, CASHIER, MANAGER)
- Product management with batch-level inventory and expiry tracking
- Prescription management with controlled substance support (DEA Schedule)
- Sales/POS with multiple payment methods
- Purchase order and supplier management
- Stock adjustments and audit logging

**Total Models**: 15 core models
**Total Enums**: 9 enumeration types
**Architecture**: Multi-tenant with tenant-level data isolation

---

## Technology Stack

This system is built using the following technology stack:

- **Backend Framework**: NestJS (TypeScript)
- **HTTP Platform**: Fastify (not Express)
- **Database**: PostgreSQL 14+
- **ORM**: Prisma
- **Authentication**: JWT (JSON Web Tokens)
- **Password Hashing**: Argon2id
- **API Documentation**: Swagger/OpenAPI
- **Testing**: Jest

**Important**: This project uses **Fastify** as the HTTP adapter for NestJS instead of the default Express. Ensure all middleware and plugins are Fastify-compatible.

---

## ID Generation Strategy

### Overview

This system uses a **hybrid ID generation approach** for optimal performance and compliance:

- **UUID v7** (Recommended): Time-ordered UUIDs for transaction and audit models
- **CUID**: Prisma default for less time-sensitive master data

### Why UUID v7?

**UUID v7 (RFC 9562)** provides significant advantages for pharmacy operations:

1. **Time-Ordered**: Natural chronological sorting critical for:
   - Sales transactions (FIFO processing)
   - Prescription dispensing (temporal tracking)
   - Audit logs (compliance reporting)
   - Token expiry management

2. **Database Performance**:
   - ~40% faster B-tree index inserts vs random UUIDs
   - ~25% faster range queries on time-ordered data
   - Better index locality reduces page splits
   - Optimal for PostgreSQL UUID type

3. **Compliance Benefits**:
   - Embedded timestamps for audit trails (HIPAA, DEA)
   - Chronological proof of record creation
   - Natural sorting without additional timestamp fields

4. **Multi-Tenant Safe**:
   - No collision risk across tenants
   - Distributed system ready
   - High entropy (74 bits randomness)

### Installation

```bash
npm install uuid
npm install --save-dev @types/uuid
```

### Implementation Pattern

**Step 1: Create UUID v7 Service**

```typescript
// src/common/services/uuid.service.ts
import { Injectable } from '@nestjs/common';
import { v7 as uuidv7 } from 'uuid';

@Injectable()
export class UuidService {
  /**
   * Generate RFC 9562 UUID v7 (time-ordered)
   * @returns UUID v7 string (e.g., '019a26ab-9a66-71a9-a89e-63c35fce4a5a')
   */
  generateV7(): string {
    return uuidv7();
  }

  /**
   * Generate UUID v7 with specific timestamp
   * Useful for testing or backfilling data
   */
  generateV7WithTimestamp(msecs: number): string {
    return uuidv7({ msecs });
  }

  /**
   * Generate multiple UUIDs with guaranteed ordering
   * Useful for batch operations
   */
  generateV7Batch(count: number): string[] {
    return Array.from({ length: count }, () => uuidv7());
  }
}
```

**Step 2: Register in Common Module**

```typescript
// src/common/common.module.ts
import { Module, Global } from '@nestjs/common';
import { UuidService } from './services/uuid.service';

@Global()
@Module({
  providers: [UuidService],
  exports: [UuidService],
})
export class CommonModule {}
```

**Step 3: Integrate with Prisma**

```typescript
// src/modules/sales/sales.service.ts
import { Injectable } from '@nestjs/common';
import { PrismaService } from '@/prisma/prisma.service';
import { UuidService } from '@/common/services/uuid.service';

@Injectable()
export class SalesService {
  constructor(
    private prisma: PrismaService,
    private uuid: UuidService,
  ) {}

  async createSale(data: CreateSaleDto) {
    const saleId = this.uuid.generateV7(); // Time-ordered ID

    return this.prisma.sale.create({
      data: {
        id: saleId,
        invoiceNumber: data.invoiceNumber,
        tenantId: data.tenantId,
        ...data,
      },
    });
  }
}
```

**Step 4: Update Prisma Schema (Optional)**

```prisma
// Option 1: Remove default, generate in service (Recommended)
model Sale {
  id String @id // Generated by UuidService
  // ...
}

// Option 2: Keep default (backward compatible)
model Sale {
  id String @id @default(cuid())
  // ...
}
```

### Model Priority Matrix

| Model | Priority | Rationale |
|-------|----------|-----------|
| **Sale** | ðŸ”´ Critical | Time-ordered transactions, FIFO processing |
| **SaleItem** | ðŸ”´ Critical | Must match parent Sale time-ordering |
| **AuditLog** | ðŸ”´ Critical | Compliance, temporal ordering required |
| **RefreshToken** | ðŸ”´ Critical | Expiry management, chronological cleanup |
| **PasswordResetToken** | ðŸ”´ Critical | Expiry management, temporal tracking |
| **Prescription** | ðŸŸ¡ High | Dispensing order, regulatory tracking |
| **PrescriptionItem** | ðŸŸ¡ High | Match parent Prescription ordering |
| **StockAdjustment** | ðŸŸ¡ High | Temporal inventory tracking |
| **ProductBatch** | ðŸŸ¡ High | Expiry date correlation |
| **PurchaseOrder** | ðŸŸ¢ Medium | Order tracking benefits from time-ordering |
| **User** | ðŸŸ¢ Low | Creation order less critical |
| **Product** | ðŸŸ¢ Low | Master data, rarely sorted by creation |
| **Customer** | ðŸŸ¢ Low | Master data, rarely sorted by creation |

### Performance Comparison

| Metric | CUID | UUID v4 | UUID v7 | Winner |
|--------|------|---------|---------|--------|
| Insert Speed | Baseline | -15% | +40% | âœ… UUID v7 |
| Range Queries | Baseline | -10% | +25% | âœ… UUID v7 |
| Sortability | âŒ Random | âŒ Random | âœ… Time | âœ… UUID v7 |

### Best Practices

âœ… **DO:**
- Use UUID v7 for transaction and audit models
- Generate IDs in service layer before Prisma operations
- Test time-ordering in integration tests
- Monitor database performance metrics

âŒ **DON'T:**
- Mix ID strategies within same model
- Rely on embedded timestamp for business logic
- Generate IDs in database layer
- Use UUID v7 for non-time-sensitive models

### Testing Example

```typescript
describe('UuidService', () => {
  it('should generate time-ordered UUIDs', () => {
    const service = new UuidService();
    const ids = service.generateV7Batch(100);
    const sorted = [...ids].sort();
    expect(ids).toEqual(sorted); // Naturally sorted
  });
});
```

---

## Core Modules Identification

Based on schema analysis, the following **11 core modules** have been identified:

| Module | Priority | Dependencies | Complexity |
|--------|----------|--------------|------------|
| 1. Authentication & Authorization | Critical | None | Medium |
| 2. Tenant Management | Critical | Auth | Low |
| 3. User Management | Critical | Auth, Tenant | Low |
| 4. Product Category Management | High | Tenant | Low |
| 5. Product Management | High | Tenant, Category | Medium |
| 6. Inventory Management | High | Product | High |
| 7. Customer Management | High | Tenant | Low |
| 8. Supplier Management | High | Tenant | Low |
| 9. Prescription Management | High | Customer, Product | Medium |
| 10. Sales/POS Module | Critical | Product, Customer, Inventory | High |
| 11. Purchase Order Management | Medium | Supplier, Product | Medium |
| 12. Stock Adjustment Module | Medium | Inventory | Medium |
| 13. Reporting & Analytics | Medium | All Modules | High |
| 14. Audit & Compliance | High | All Modules | Medium |

---

## Implementation Phases

### **Phase 1: Foundation & Infrastructure** (Weeks 1-3)
**Goal**: Establish core authentication, multi-tenancy, and foundational services

#### 1.1 Authentication & Authorization Module
**Priority**: Critical
**Estimated Effort**: 1.5 weeks

**Components**:
- JWT-based authentication service
- Password hashing (argon2)
- Login/logout endpoints
- Token refresh mechanism
- Role-based access control (RBAC) middleware
- Permission guards for routes

**Deliverables**:
```
src/modules/auth/
â”œâ”€â”€ auth.controller.ts       # Login, logout, refresh endpoints
â”œâ”€â”€ auth.service.ts          # Authentication business logic
â”œâ”€â”€ auth.module.ts           # Module definition
â”œâ”€â”€ dto/
â”‚   â”œâ”€â”€ login.dto.ts         # Login request validation
â”‚   â””â”€â”€ register.dto.ts      # User registration validation
â”œâ”€â”€ guards/
â”‚   â”œâ”€â”€ jwt-auth.guard.ts    # JWT authentication guard
â”‚   â””â”€â”€ roles.guard.ts       # Role-based authorization guard
â”œâ”€â”€ decorators/
â”‚   â”œâ”€â”€ current-user.decorator.ts  # Extract current user
â”‚   â””â”€â”€ roles.decorator.ts         # Role metadata decorator
â””â”€â”€ strategies/
    â””â”€â”€ jwt.strategy.ts      # JWT validation strategy
```

**Key Features**:
- âœ… User login with username/email and password
- âœ… JWT token generation (access + refresh tokens)
- âœ… Token validation and refresh
- âœ… Role-based route protection
- âœ… Password reset functionality
- âœ… Account lockout after failed attempts

**Testing Requirements**:
- Unit tests for auth service
- Integration tests for login/logout
- E2E tests for protected routes

---

#### 1.2 Tenant Management Module
**Priority**: Critical
**Estimated Effort**: 1 week

**Components**:
- Tenant CRUD operations
- Tenant context middleware (extracts tenant from request)
- Tenant-scoped data access patterns
- Tenant settings management

**Deliverables**:
```
src/modules/tenant/
â”œâ”€â”€ tenant.controller.ts     # Tenant CRUD endpoints
â”œâ”€â”€ tenant.service.ts        # Tenant business logic
â”œâ”€â”€ tenant.module.ts
â”œâ”€â”€ dto/
â”‚   â”œâ”€â”€ create-tenant.dto.ts
â”‚   â””â”€â”€ update-tenant.dto.ts
â”œâ”€â”€ middleware/
â”‚   â””â”€â”€ tenant-context.middleware.ts  # Extract tenant from request
â””â”€â”€ decorators/
    â””â”€â”€ current-tenant.decorator.ts   # Get current tenant
```

**Key Features**:
- âœ… Create, read, update, deactivate tenants
- âœ… Tenant code uniqueness validation
- âœ… Tenant settings management (JSON configuration)
- âœ… Tenant context extraction from JWT or subdomain
- âœ… Automatic tenant filtering in all queries

**Multi-Tenancy Strategy**:
- **Approach**: Row-level tenant isolation via `tenantId` foreign key
- **Access Pattern**: All queries must include `tenantId` filter
- **Middleware**: Inject tenant context into request object
- **Validation**: Prevent cross-tenant data access

---

#### 1.3 User Management Module
**Priority**: Critical
**Estimated Effort**: 0.5 weeks

**Components**:
- User CRUD operations (tenant-scoped)
- User profile management
- Role assignment
- User activation/deactivation

**Deliverables**:
```
src/modules/user/
â”œâ”€â”€ user.controller.ts       # User management endpoints
â”œâ”€â”€ user.service.ts          # User business logic
â”œâ”€â”€ user.module.ts
â””â”€â”€ dto/
    â”œâ”€â”€ create-user.dto.ts   # User creation with role
    â””â”€â”€ update-user.dto.ts   # User profile update
```

**Key Features**:
- âœ… CRUD operations (tenant-scoped)
- âœ… Role management (ADMIN, PHARMACIST, CASHIER, MANAGER)
- âœ… Username uniqueness per tenant
- âœ… User profile updates
- âœ… Password change functionality

---

### **Phase 2: Master Data Management** (Weeks 4-6)
**Goal**: Implement core master data modules for products, customers, and suppliers

#### 2.1 Product Category Management
**Priority**: High
**Estimated Effort**: 0.5 weeks

**Deliverables**:
```
src/modules/product-category/
â”œâ”€â”€ product-category.controller.ts
â”œâ”€â”€ product-category.service.ts
â”œâ”€â”€ product-category.module.ts
â””â”€â”€ dto/
    â”œâ”€â”€ create-category.dto.ts
    â””â”€â”€ update-category.dto.ts
```

**Key Features**:
- âœ… Category CRUD (tenant-scoped)
- âœ… Category hierarchy support (optional parent-child)
- âœ… Active/inactive status management

---

#### 2.2 Product Management Module
**Priority**: High
**Estimated Effort**: 2 weeks

**Components**:
- Product master data CRUD
- Barcode generation and validation
- DEA Schedule classification
- Minimum stock level management
- Product search and filtering

**Deliverables**:
```
src/modules/product/
â”œâ”€â”€ product.controller.ts
â”œâ”€â”€ product.service.ts
â”œâ”€â”€ product.module.ts
â””â”€â”€ dto/
    â”œâ”€â”€ create-product.dto.ts
    â”œâ”€â”€ update-product.dto.ts
    â””â”€â”€ search-product.dto.ts
```

**Key Features**:
- âœ… Product CRUD with barcode support
- âœ… Generic name and manufacturer tracking
- âœ… Prescription requirement flag
- âœ… DEA Schedule classification (controlled substances)
- âœ… Minimum stock level alerts
- âœ… Product search (by code, barcode, name, generic name)
- âœ… Category assignment

**Advanced Features**:
- ðŸ”„ Barcode scanning integration
- ðŸ”„ Auto-generate product codes
- ðŸ”„ Duplicate product detection

---

#### 2.3 Customer Management Module
**Priority**: High
**Estimated Effort**: 1.5 weeks

**Deliverables**:
```
src/modules/customer/
â”œâ”€â”€ customer.controller.ts
â”œâ”€â”€ customer.service.ts
â”œâ”€â”€ customer.module.ts
â””â”€â”€ dto/
    â”œâ”€â”€ create-customer.dto.ts
    â”œâ”€â”€ update-customer.dto.ts
    â””â”€â”€ search-customer.dto.ts
```

**Key Features**:
- âœ… Customer CRUD (tenant-scoped)
- âœ… Customer code auto-generation
- âœ… Insurance information management
- âœ… Allergy tracking (JSON field)
- âœ… Customer search (by code, name, phone, insurance)
- âœ… Purchase history view

**Insurance Features**:
- Insurance provider and policy tracking
- Insurance expiry date monitoring
- Insurance validation for sales

---

#### 2.4 Supplier Management Module
**Priority**: High
**Estimated Effort**: 1 week

**Deliverables**:
```
src/modules/supplier/
â”œâ”€â”€ supplier.controller.ts
â”œâ”€â”€ supplier.service.ts
â”œâ”€â”€ supplier.module.ts
â””â”€â”€ dto/
    â”œâ”€â”€ create-supplier.dto.ts
    â””â”€â”€ update-supplier.dto.ts
```

**Key Features**:
- âœ… Supplier CRUD (tenant-scoped)
- âœ… Supplier code uniqueness
- âœ… Contact person and payment terms
- âœ… Supplier performance tracking (future enhancement)

---

### **Phase 3: Inventory & Prescription Management** (Weeks 7-10)
**Goal**: Implement core operational modules

#### 3.1 Inventory Management Module (Product Batch)
**Priority**: High
**Estimated Effort**: 2.5 weeks

**Components**:
- Product batch CRUD
- Batch-level stock tracking
- Expiry date monitoring
- FEFO (First Expiry First Out) logic
- Stock level calculations
- Low stock alerts

**Deliverables**:
```
src/modules/inventory/
â”œâ”€â”€ inventory.controller.ts
â”œâ”€â”€ inventory.service.ts
â”œâ”€â”€ inventory.module.ts
â”œâ”€â”€ dto/
â”‚   â”œâ”€â”€ create-batch.dto.ts
â”‚   â”œâ”€â”€ update-batch.dto.ts
â”‚   â””â”€â”€ stock-inquiry.dto.ts
â””â”€â”€ jobs/
    â””â”€â”€ expiry-alert.job.ts   # Cron job for expiry alerts
```

**Key Features**:
- âœ… Batch creation when receiving stock
- âœ… Batch-level quantity tracking
- âœ… Expiry date validation (prevent sale of expired items)
- âœ… FEFO logic for batch selection during sales
- âœ… Current stock inquiry (aggregated from batches)
- âœ… Low stock alerts (based on Product.minStockLevel)
- âœ… Expiry alerts (configurable threshold, e.g., 30/60/90 days)

**Advanced Features**:
- ðŸ”„ Automatic batch deactivation on expiry
- ðŸ”„ Batch transfer between locations (if multi-location)

---

#### 3.2 Stock Adjustment Module
**Priority**: Medium
**Estimated Effort**: 1 week

**Deliverables**:
```
src/modules/stock-adjustment/
â”œâ”€â”€ stock-adjustment.controller.ts
â”œâ”€â”€ stock-adjustment.service.ts
â”œâ”€â”€ stock-adjustment.module.ts
â””â”€â”€ dto/
    â””â”€â”€ create-adjustment.dto.ts
```

**Key Features**:
- âœ… Stock adjustments (DAMAGE, EXPIRY, THEFT, CORRECTION, RETURN)
- âœ… Quantity before/after tracking
- âœ… Reason and adjusted-by tracking
- âœ… Automatic batch quantity update
- âœ… Adjustment history view

**Business Rules**:
- Adjustments must provide reason
- Cannot adjust quantity below zero
- Audit log for all adjustments

---

#### 3.3 Prescription Management Module
**Priority**: High
**Estimated Effort**: 2 weeks

**Deliverables**:
```
src/modules/prescription/
â”œâ”€â”€ prescription.controller.ts
â”œâ”€â”€ prescription.service.ts
â”œâ”€â”€ prescription.module.ts
â”œâ”€â”€ prescription-item.service.ts
â””â”€â”€ dto/
    â”œâ”€â”€ create-prescription.dto.ts
    â”œâ”€â”€ update-prescription.dto.ts
    â””â”€â”€ prescription-item.dto.ts
```

**Key Features**:
- âœ… Prescription CRUD (tenant-scoped)
- âœ… Prescription number auto-generation
- âœ… Doctor information capture
- âœ… Prescription items (dosage, frequency, duration)
- âœ… Prescription validation (valid until date)
- âœ… Status management (ACTIVE, DISPENSED, EXPIRED, CANCELLED)
- âœ… Link prescription to sale

**Business Rules**:
- Validate prescription before sale
- Automatically expire prescriptions past valid date
- Prevent sale of controlled substances without valid prescription
- Track dispensed quantities vs prescribed quantities

---

### **Phase 4: Sales & Purchase Operations** (Weeks 11-14)
**Goal**: Implement transaction processing modules

#### 4.1 Sales/POS Module
**Priority**: Critical
**Estimated Effort**: 3 weeks

**Components**:
- Sales transaction processing
- Invoice generation
- Payment processing (CASH, CARD, INSURANCE, DIGITAL_WALLET)
- Receipt generation
- Sale returns and cancellations
- Prescription linking

**Deliverables**:
```
src/modules/sales/
â”œâ”€â”€ sales.controller.ts
â”œâ”€â”€ sales.service.ts
â”œâ”€â”€ sales.module.ts
â”œâ”€â”€ sale-item.service.ts
â”œâ”€â”€ dto/
â”‚   â”œâ”€â”€ create-sale.dto.ts
â”‚   â”œâ”€â”€ sale-item.dto.ts
â”‚   â””â”€â”€ return-sale.dto.ts
â””â”€â”€ utils/
    â”œâ”€â”€ invoice-generator.ts
    â””â”€â”€ receipt-generator.ts
```

**Key Features**:
- âœ… Create sale with multiple items
- âœ… Automatic invoice number generation
- âœ… Batch selection using FEFO logic
- âœ… Stock deduction on sale completion
- âœ… Multiple payment methods
- âœ… Partial payment support
- âœ… Prescription validation for controlled substances
- âœ… Customer linking (optional/required for insurance)
- âœ… Discount application (item-level and sale-level)
- âœ… Tax calculation
- âœ… Sale returns (RETURNED status, stock restoration)
- âœ… Sale cancellations (CANCELLED status, stock restoration)

**Business Rules**:
- Validate stock availability before sale
- Check product expiry before sale
- Require prescription for products with `requiresPrescription = true`
- Additional validation for DEA Schedule II-IV products
- Prevent sale of expired batches
- Update prescription status to DISPENSED after sale

**Advanced Features**:
- ðŸ”„ Receipt printing (PDF generation)
- ðŸ”„ Barcode scanning for quick item addition
- ðŸ”„ Insurance claim processing

---

#### 4.2 Purchase Order Management Module
**Priority**: Medium
**Estimated Effort**: 2 weeks

**Deliverables**:
```
src/modules/purchase-order/
â”œâ”€â”€ purchase-order.controller.ts
â”œâ”€â”€ purchase-order.service.ts
â”œâ”€â”€ purchase-order.module.ts
â””â”€â”€ dto/
    â”œâ”€â”€ create-po.dto.ts
    â”œâ”€â”€ receive-po.dto.ts
    â””â”€â”€ cancel-po.dto.ts
```

**Key Features**:
- âœ… Create purchase orders
- âœ… Order number auto-generation
- âœ… Supplier assignment
- âœ… Expected delivery date tracking
- âœ… PO status management (PENDING, RECEIVED, CANCELLED)
- âœ… Receive PO (creates product batches)
- âœ… Partial receiving support

**Business Rules**:
- PO can only be received once (or partially multiple times)
- Receiving PO creates ProductBatch records
- Update PO status to RECEIVED when fully received

---

### **Phase 5: Reporting & Analytics** (Weeks 15-17)
**Goal**: Implement reporting and business intelligence

#### 5.1 Reporting Module
**Priority**: Medium
**Estimated Effort**: 2.5 weeks

**Deliverables**:
```
src/modules/reporting/
â”œâ”€â”€ reporting.controller.ts
â”œâ”€â”€ reporting.service.ts
â”œâ”€â”€ reporting.module.ts
â””â”€â”€ reports/
    â”œâ”€â”€ sales-report.service.ts
    â”œâ”€â”€ inventory-report.service.ts
    â”œâ”€â”€ expiry-report.service.ts
    â””â”€â”€ financial-report.service.ts
```

**Report Types**:

**A. Sales Reports**:
- Daily/weekly/monthly sales summary
- Sales by product
- Sales by customer
- Sales by payment method
- Sales by user (cashier performance)
- Top-selling products

**B. Inventory Reports**:
- Current stock levels
- Low stock alert report
- Expiry report (upcoming expirations)
- Dead stock report (no movement in X days)
- Stock valuation report

**C. Financial Reports**:
- Revenue summary
- Profit/loss by product
- Payment collection report
- Outstanding payments

**D. Compliance Reports**:
- Controlled substance dispensing log (DEA reporting)
- Prescription audit log
- User activity report

**Advanced Features**:
- ðŸ”„ Export to Excel/PDF
- ðŸ”„ Scheduled report generation
- ðŸ”„ Dashboard with charts/graphs

---

### **Phase 6: Audit & Compliance** (Weeks 18-19)
**Goal**: Implement audit logging and compliance features

#### 6.1 Audit Logging Module
**Priority**: High
**Estimated Effort**: 1.5 weeks

**Deliverables**:
```
src/modules/audit/
â”œâ”€â”€ audit.service.ts
â”œâ”€â”€ audit.module.ts
â”œâ”€â”€ interceptors/
â”‚   â””â”€â”€ audit-log.interceptor.ts  # Automatic audit logging
â””â”€â”€ dto/
    â””â”€â”€ audit-query.dto.ts
```

**Key Features**:
- âœ… Automatic audit logging for all CREATE/UPDATE/DELETE operations
- âœ… Track old values and new values (JSON diff)
- âœ… IP address capture
- âœ… User and timestamp tracking
- âœ… Entity type and ID indexing
- âœ… Audit log search and filtering

**Entities to Audit**:
- Product changes (especially controlled substances)
- Sale transactions
- Prescription dispensing
- Stock adjustments
- User changes
- Tenant configuration changes

**Compliance Features**:
- ðŸ”„ Audit log retention policy
- ðŸ”„ Immutable audit logs (append-only)
- ðŸ”„ Audit log export for regulatory compliance

---

## Cross-Cutting Concerns

### Error Handling Strategy
```typescript
// Standard error response format
{
  statusCode: 400,
  message: "Validation failed",
  errors: [
    { field: "email", message: "Invalid email format" }
  ],
  timestamp: "2025-01-11T10:30:00Z"
}
```

**Error Categories**:
- Validation errors (400)
- Authentication errors (401)
- Authorization errors (403)
- Not found errors (404)
- Business logic errors (422)
- Server errors (500)

---

### Validation Strategy
- Use **class-validator** decorators in DTOs
- Implement custom validators for business rules
- Tenant-scoped validation (e.g., unique product code per tenant)

---

### Database Transaction Management
**Critical Operations Requiring Transactions**:
1. **Sale Creation**: Insert Sale + SaleItems + Update ProductBatch quantities
2. **Sale Return**: Update Sale status + Restore ProductBatch quantities
3. **PO Receiving**: Update PO status + Create ProductBatch records
4. **Stock Adjustment**: Insert StockAdjustment + Update ProductBatch quantity

**Implementation Pattern**:
```typescript
await prisma.$transaction(async (tx) => {
  // Perform multiple operations
  // All succeed or all rollback
});
```

---

### Performance Optimization

**Database Indexes** (Already defined in schema):
- Tenant-based indexes on all models
- Composite indexes for common queries
- Date-based indexes for time-series queries

**Caching Strategy**:
- Cache tenant settings (Redis)
- Cache product master data (short TTL)
- Cache user permissions

**Pagination**:
- Implement cursor-based pagination for large datasets
- Default page size: 20-50 records

---

### Security Considerations

1. **Authentication**:
   - JWT with short expiration (15 minutes access, 7 days refresh)
   - Secure password hashing (argon2id with recommended defaults)
   - Account lockout after 5 failed attempts

2. **Authorization**:
   - Role-based access control (RBAC)
   - Tenant-level data isolation (row-level security)
   - Prevent privilege escalation

3. **Data Protection**:
   - Encrypt sensitive data at rest (customer allergies, insurance info)
   - HTTPS/TLS for data in transit
   - SQL injection prevention (Prisma ORM)

4. **Compliance**:
   - HIPAA compliance for patient data (if applicable)
   - DEA regulations for controlled substances
   - Data retention policies

---

## Testing Strategy

### Unit Tests
- Service layer business logic
- Utility functions
- Validation logic

**Target Coverage**: 80%+

### Integration Tests
- API endpoint testing
- Database interaction testing
- Multi-module workflows

**Target Coverage**: 70%+

### E2E Tests
- Critical user flows:
  - User login â†’ Product search â†’ Create sale
  - Receive PO â†’ Create batches â†’ Stock inquiry
  - Create prescription â†’ Validate â†’ Dispense

**Target Coverage**: Key workflows only

---

## Deployment Considerations

### Environment Configuration
```
# Required Environment Variables
DATABASE_URL=postgresql://...
JWT_SECRET=...
JWT_REFRESH_SECRET=...
JWT_EXPIRATION=15m
JWT_REFRESH_EXPIRATION=7d
# Argon2 will use recommended defaults (argon2id variant)
```

### Migration Strategy
```bash
# Run Prisma migrations
npx prisma migrate deploy

# Seed initial data (optional)
npx prisma db seed
```

### Monitoring & Logging
- Application logging (Winston/Pino)
- Error tracking (Sentry)
- Performance monitoring (New Relic/DataDog)
- Database query monitoring

---

## Success Criteria

### Phase 1 (Foundation)
- âœ… Users can log in and access protected routes
- âœ… Tenant context is automatically applied to all queries
- âœ… Role-based access control is enforced

### Phase 2 (Master Data)
- âœ… Products, customers, and suppliers can be managed
- âœ… Barcode scanning works for product lookup
- âœ… Insurance information is captured and validated

### Phase 3 (Operations)
- âœ… Inventory levels are accurate and updated in real-time
- âœ… Expiry alerts are generated automatically
- âœ… Prescriptions can be validated and linked to sales

### Phase 4 (Transactions)
- âœ… Sales can be processed with multiple payment methods
- âœ… Stock is automatically deducted on sale completion
- âœ… Purchase orders can be received and create batches

### Phase 5 (Reporting)
- âœ… Key reports are available (sales, inventory, expiry)
- âœ… Reports can be exported to Excel/PDF

### Phase 6 (Audit)
- âœ… All critical operations are logged
- âœ… Audit logs are searchable and exportable

---

## Risk Assessment & Mitigation

| Risk | Impact | Probability | Mitigation |
|------|--------|-------------|------------|
| Schema changes required | High | Low | Schema is well-designed; changes unlikely |
| Multi-tenancy bugs (data leakage) | Critical | Medium | Comprehensive testing; middleware validation |
| Performance issues with large datasets | Medium | Medium | Proper indexing; caching; pagination |
| Controlled substance compliance | High | Low | Strict validation; audit logging; DEA reporting |
| Integration with barcode scanners | Medium | Low | Use standard formats (UPC/EAN); test with hardware |

---

## Next Steps

1. **Week 1**: Set up project structure and initialize Phase 1
2. **Week 2-3**: Complete authentication and tenant management
3. **Week 4**: Begin Phase 2 (master data modules)
4. **Review Checkpoint**: End of Phase 2 (Week 6)
5. **Week 7-10**: Implement Phase 3 (inventory and prescriptions)
6. **Review Checkpoint**: End of Phase 3 (Week 10)
7. **Week 11-14**: Implement Phase 4 (sales and purchase orders)
8. **Review Checkpoint**: End of Phase 4 (Week 14)
9. **Week 15-19**: Implement Phase 5-6 (reporting and audit)
10. **Final Review**: End of Phase 6 (Week 19)

---

## Conclusion

This implementation plan provides a structured approach to building the Pharmacy Management System based on the existing schema. The phased approach ensures:

- **Progressive delivery**: Each phase delivers working features
- **Dependency management**: Modules are built in the correct order
- **Risk mitigation**: Critical modules are prioritized
- **Quality assurance**: Testing is integrated throughout

**Total Estimated Timeline**: 19 weeks (approximately 4.5 months)

**Team Recommendation**: 2-3 backend developers, 1 QA engineer

---

## Document Version
- **Version**: 1.0
- **Date**: 2025-01-11
- **Author**: System Analysis
- **Status**: Draft for Review
